<!doctype html>
<html lang="en">
<head>
    <title>d3 data viz tutorial</title>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.0/d3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <style>
        div.tooltip {
            position: absolute;
            text-align: center;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<script>
    // set the dimensions and margins of the graph
    var margin = {top: 30, right: 30, bottom: 70, left: 60},
        width = 460 - margin.left - margin.right,
        height = 300 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        // questi due qui sotto non ci sono in SO:
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");


    // Parse the Data
    d3.csv("new_single_barchart.csv", function(data) {

        // Get the columns.
        var historianNames = data.columns.slice(1);

        // Create a select element
        var select = d3.select("body")
            .append("select")
            .on("change", update)

        // Add an initial option:
        select.append("option")
            .html("Select an art historian:")

        // Add the options:
        var options = select.selectAll(null)
            .data(historianNames)
            .enter()
            .append("option")
            .text(function(d) { return d; });

        // X axis (scale)
        var x = d3.scaleBand()
            .range([ 0, width ])
            .domain(data.map(function(d) { return d.obj_type; }))
            .padding(0.2);

        // Add Y axis (scale)
        var y = d3.scaleLinear()
            .domain([0, 16])
            .range([ height, 0]);

        // Specify an Update function to create and update visualization elements:
        function update() {
            var historianName = this.value; // e.g. Ulrich Middeldorf
            var bars = svg.selectAll("rect").data(data);


            bars.enter()
                .append("rect")
                .attr("x", function(d) { return x(d.obj_type); })
                .attr("width", x.bandwidth())
                .attr("y", 150)
                .attr("height",0)
                .merge(bars)
                .transition()
                .attr("height", function(d) { return height - y(d[historianName] || 0); })
                .attr("fill", "#69b3a2")
                .attr("y", function(d) { return y(d[historianName] || 0); });

            svg.append("g")
                .call(d3.axisLeft(y));

            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("text-anchor", "end");

            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            svg.selectAll("rect")
                .on("mouseover", function() {
                    d3.csv("new_renaissance_subjects.csv",
                        function(newdata) {
                            var subjects = newdata;
                            var selected_obj_type = d['obj_type'];
                            var res = subjects.filter(({ obj_type }) => selected_obj_type === obj_type);
                            div.html(res[0][historianName].replace(/, /g, " <br>"))
                        });
                    div.transition()
                        .duration(200)
                        .style("opacity", .9);
                    d3.select(this).attr("fill", "blue");
                })
                .on("mousemove", function (d) {
                    d3.csv("new_renaissance_subjects.csv",
                        function(newdata) {
                            var subjects = newdata;
                            var selected_obj_type = d['obj_type'];
                            var res = subjects.filter(({ obj_type }) => selected_obj_type === obj_type);
                            div.html(res[0][historianName].replace(/, /g, " <br>"))
                        });
                        div .style("left", (d3.mouse(this)[0] + 70) + "px")
                            .style("top", (d3.mouse(this)[1]) + "px");
                    d3.select(this).attr("fill", "blue");
                })
                .on("mouseout", function() {
                    div.transition()
                        .duration(200)
                        .style("opacity", 0);
                    d3.select(this).attr("fill", "#69b3a2");
                });

        } // si chiude la funzione update

    }) // si chiude la funzione che fa il parsing del csv




</script>
</body>
</html>