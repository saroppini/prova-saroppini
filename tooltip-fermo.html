<!doctype html>
<html lang="en">
<head>
    <title>d3 data viz tutorial</title>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.10.0/d3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <!--<script src="d3/d3.js"></script>
    <script src="d3/d3.min.js"></script>-->

    <style>
        div.tooltip {
            position: absolute;
            text-align: center;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            visibility: hidden;
        }

        .grid .tick line {
            stroke: #9FAAAE;
            stroke-opacity: 0.3;
        }

        .grid path {
            stroke-width: 0;
        }
    </style>
</head>
<body>
<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>

<script>
    // set the dimensions and margins of the graph
    var margin = {top: 30, right: 30, bottom: 70, left: 60},
        width = 460 - margin.left - margin.right,
        height = 300 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        // questi due qui sotto non ci sono in SO:
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");


    // Parse the Data
    d3.csv("new_renaissance_subjects.csv", function(data) {

        // Get the columns.
        var historianNames = data.columns.slice(1);

        // Create a select element
        var select = d3.select("body")
            .append("select")
            .on("change", update)

        // Add an initial option:
        select.append("option")
            .html("Select an art historian:")

        // Add the options:
        var options = select.selectAll(null)
            .data(historianNames)
            .enter()
            .append("option")
            .text(function(d) { return d; });

        // X axis (scale)
        var x = d3.scaleBand()
            .range([ 0, width ])
            .domain(data.map(function(d) { return d.obj_type; }))
            .padding(0.2);


        // Add Y axis (scale)
        var y = d3.scaleLinear()
            .domain([0, 16])
            .range([ height, 0]);

        // Specify an Update function to create and update visualization elements:
        function update() {
            var historianName = this.value; // e.g. Ulrich Middeldorf
            var bars = svg.selectAll("rect").data(data);

            const makeYLines = () => d3.axisLeft().scale(y)
            svg.append('g')
                .attr('class', 'grid')
                .call(makeYLines()
                    .tickSize(-width, 0, 0)
                    .tickFormat('')
                )

            bars.enter()
                .append("rect")
                .attr("x", function(d) { return x(d.obj_type); })
                .attr("width", x.bandwidth())
                .attr("y", 150)
                .attr("height",0)
                .merge(bars)
                .transition()
                .attr("height", function(d) {
                    if (d[historianName] === '0') { return height - y(0); }
                    else {return height - y(d[historianName].split(", ").length || 0);}
                })
                .attr("fill", "#69b3a2")
                .attr("y", function(d) {
                    if (d[historianName] === '0') { return y(0); }
                    else {return y(d[historianName].split(", ").length || 0);}
                });

            svg.append("g")
                .call(d3.axisLeft(y));

            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("text-anchor", "end");

            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);


            svg.selectAll("rect")
                .on("mouseover", function(d) {
                    div .style('top', d3.event.target.getBoundingClientRect().top + 'px')
                        .style('left', (x(d.obj_type) + x.bandwidth()*1.8) + 'px')
                        .html(d[historianName].replace(/, /g, " <br>"));
                    div.style('visibility', 'visible')
                        .style("opacity", .9)
                })
                .on("mousemove", function () {
                    d3.select(this)
                        .attr("fill", "#5f9f8e")
                        .style("opacity", 1)
                        .transition()
                        .duration(200)
                        .attr('x', (d) => x(d.obj_type) - 3)
                        .attr('width', x.bandwidth() + 6)
                })
                .on("mouseout", function() {
                    div.style('visibility', 'hidden')
                        .style("opacity", 0);
                    d3.select(this)
                        .attr("fill", "#69b3a2")
                        .style("opacity", 1)
                        .transition()
                        .duration(200)
                        .attr('x', (d) => x(d.obj_type))
                        .attr('width', x.bandwidth())
                });

        } // si chiude la funzione update

    }) // si chiude la funzione che fa il parsing del csv




</script>
</body>
</html>