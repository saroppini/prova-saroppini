<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>open science course</title>
    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <!-- <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <style>
        div#scroll {
            margin: auto;
            overflow-y:scroll;
            width:70vw;
            height:40vh;
            box-shadow: 1px 1px 10px #dfdfdf;
            border-radius: 7px;
        }

        div#bar-citing {
            width: fit-content;
            margin: 50px auto;
        }

        svg {
            font: 10px sans-serif;
            shape-rendering: crispEdges;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
        }

        path.domain {
            stroke: none;
        }

        .y .tick line {
            stroke: #ddd;
        }

    </style>
</head>
<body>

<div id="scroll">
    <table id="tab_citing" class="table">
        <tr>
            <th>publisher</th>
            <th>invalid citing</th>
            <th>valid citing</th>
            <th>total citing</th>
        </tr>
    </table>
</div>

<div id="bar-citing"></div>

<script type="text/javascript">

    var data = jQuery.getJSON('output_read_only.json', function(json) {
        var keys = [];

        var array_of_dict = []; //data structure for the bar graph

        console.log(json);

        for (var p in json["publishers"]){
            keys.push(p); //p["name"] ? per metterli in ordine alfabetico
        }

        for(var pub of keys.sort()){
            var name = json["publishers"][pub]["name"];
            var invalid_citing = json["publishers"][pub]["responsible_for_i"];
            var valid_citing= json["publishers"][pub]["responsible_for_v"];
            var table = document.getElementById("tab_citing");

            var row = table.insertRow(-1);
            row.insertCell(0).innerHTML = name;
            row.insertCell(1).innerHTML = invalid_citing;
            row.insertCell(2).innerHTML = valid_citing;
            row.insertCell(3).innerHTML = invalid_citing+valid_citing;

            // has to be 19 in the real world
            if (array_of_dict.length <= 19) {
                array_of_dict.push({
                    "publisher": name,
                    "invalid_citing": invalid_citing,
                    "valid_citing": valid_citing,
                    "total": invalid_citing+valid_citing
                });

            }
            else {
                var pos = 0;
                var smallest = array_of_dict[0]["total"];
                for (d of array_of_dict) {
                    if (d["total"] < smallest) {
                        smallest = d['total'];
                        pos = array_of_dict.indexOf(d);
                    }
                }
                if (invalid_citing+valid_citing > smallest) {
                    array_of_dict[pos]["publisher"] = name;
                    array_of_dict[pos]["invalid_citing"] = invalid_citing;
                    array_of_dict[pos]["valid_citing"] = valid_citing;
                    array_of_dict[pos]["total"] = invalid_citing+valid_citing;
                }

            }

        } // si chiude il for loop

        // sort array of dict in ordine decrescente
        array_of_dict.sort(function(a,b) {
            return b.total - a.total
        });





        // bar chart
        var margin = {top: 20, right: 160, bottom: 35, left: 30};
        var width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        var svg = d3.select("#bar-citing")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Set x, y and colors
        //var x = d3.scale.ordinal()
        //.rangeRoundBands([10, width-10], 0.02);

        var y = d3.scaleLinear()
            //.domain([0, d3.max(dataset, function(d) {  return d3.max(d, function(d) { return d.y0 + d.y; });  })])
            .rangeRound([height, 0]);


        // set x scale
        var x = d3.scaleBand()
            .rangeRound([0, width])
            .paddingInner(0.05);
        //.domain(dataset.map(function(d) { return d.x; }));
        //.align(0.1);




        // Transpose the data into layers
        var stack = d3.stack()
            .keys(["invalid_citing", "valid_citing"])
            .order(d3.stackOrderNone)
            .offset(d3.stackOffsetNone);


        console.log(array_of_dict)
        var dataset = stack(array_of_dict);
        x.domain(array_of_dict.map(function(d) { return d["publisher"]; }));
        y.domain([0, d3.max(dataset[dataset.length - 1], function(d) { return d[0] + d[1]; }) ]).nice();


        console.log(dataset)






        var colors = ["#b33040", "#d9d574"];


        // Define and draw axes
        var yAxis = d3.axisLeft()
            .scale(y)
            .ticks(5)
            .tickSize(-width, 0, 0)
            .tickFormat( function(d) { return d } );

        var xAxis = d3.axisBottom()
            .scale(x);

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis);

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);


        // Create groups for each series, rects for each segment
        var groups = svg.selectAll("g.cost")
            .data(dataset)
            .enter().append("g")
            .attr("class", "cost")
            .style("fill", function(d, i) { return colors[i]; });


        var rect = groups.selectAll("rect")
            .data(function(d) { return d; })
            .enter()
            .append("rect")
            .attr("x", function(d) { return x(d.x); })
            .attr("y", function(d) { return y(d.y0 + d.y); })
            .attr("height", function(d) { return y(d[0]) - y(d[1]) -1; })
            .attr("width", x.bandwidth())
            .on("mouseover", function() { tooltip.style("display", null); })
            .on("mouseout", function() { tooltip.style("display", "none"); })
            .on("mousemove", function(d) {
                var xPosition = d3.mouse(this)[0] - 15;
                var yPosition = d3.mouse(this)[1] - 25;
                tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
                tooltip.select("text").text(d.y);
                console.log(tooltip.style("display"))
            });


        // Prep the tooltip bits, initial display is hidden
        var tooltip = svg.append("g")
            .attr("class", "tooltip")
            .style("display", "none");

        tooltip.append("rect")
            .attr("width", 30)
            .attr("height", 20)
            .attr("fill", "white")
            .style("opacity", 0.5);

        tooltip.append("text")
            .attr("x", 15)
            .attr("dy", "1.2em")
            .style("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-weight", "bold");



        // Draw legend
        var legend = svg.selectAll(".legend")
            .data(colors)
            .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function(d, i) { return "translate(30," + i * 19 + ")"; });

        legend.append("rect")
            .attr("x", width - 18)
            .attr("width", 18)
            .attr("height", 18)
            .style("fill", function(d, i) {return colors.slice().reverse()[i];});

        legend.append("text")
            .attr("x", width + 5)
            .attr("y", 9)
            .attr("dy", ".35em")
            .style("text-anchor", "start")
            .text(function(d, i) {
                switch (i) {
                    case 0: return "valid citing";
                    case 1: return "invalid citing";
                }
            });

    });

</script>

</body>
</html>